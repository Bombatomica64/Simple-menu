<div class="menu-management-container">
	<div class="header-section">
		<div class="flex justify-content-between align-items-center">
			<h2>Aggiorna Menu</h2>
		</div>

		@if (menuWsConnection?.connected() === false) {
		<div class="connection-status disconnected">
			<p>Connessione al servizio menu...</p>
		</div>
		} @if (menuWsConnection?.connected()) {
		<div class="connection-status connected">
			<p>Connesso al servizio menu</p>
		</div>
		}
	</div>

	@if (menuWsConnection?.connected()) {
	<div class="content-sections">
		<!-- Menu Items Section -->
		<div class="card p-mb-4">
			<h3>Voci del Menu</h3>

			<div class="form-section">
				<h4>Aggiungi nuovo piatto</h4>
				<div class="p-fluid p-formgrid p-grid">
					<div class="p-field p-col-12 p-md-4">
						<label for="itemName">Nome:</label>
						<input
							id="itemName"
							type="text"
							pInputText
							[(ngModel)]="newItemName"
							placeholder="Nome della voce"
						/>
					</div>
					<div class="p-field p-col-12 p-md-3">
						<label for="itemPrice">Prezzo:</label>
						<input
							id="itemPrice"
							type="number"
							pInputText
							[(ngModel)]="newItemPrice"
							placeholder="Prezzo della voce"
						/>
					</div>
					<div class="p-field p-col-12 p-md-3">
						<label for="itemSection">Sezione:</label>
						<p-dropdown
							id="itemSection"
							[(ngModel)]="newItemSectionId"
							[options]="availableSections()"
							optionLabel="label"
							optionValue="value"
							placeholder="Seleziona sezione"
							[showClear]="true">
						</p-dropdown>
					</div>
					<div class="p-field p-col-12 p-md-2 component-buttons">
						<button
							pButton
							type="button"
							label="Aggiungi Voce"
							(click)="addItem()"
							class="p-mt-4"
							title="Aggiungi nuova voce del menu"
						></button>
					</div>
				</div>
			</div>

			<hr class="p-my-3" />

			<!-- Menu Sections with Items -->
			@defer { @if (menuWsConnection?.resource?.value(); as menu) {
			<app-menu-sections
				[menuItems]="menu.menuItems"
				[sections]="menu.menuSections || []"
				(removeItem)="removeItemById($event)"
				(toggleShowImage)="toggleMenuItemShowImage($event.itemId, $event.showImage)"
				(openImageManager)="openMenuItemImageManager($event)"
				(sectionsChanged)="onSectionsChanged($event)"
				(moveItemToSection)="onMoveItemToSection($event)"
				(updateItemPositions)="onUpdateItemPositions($event)">
			</app-menu-sections>
			} } @placeholder {
			<div class="text-center p-4">
				<i class="pi pi-spin pi-spinner text-2xl text-500"></i>
				<p class="text-500 mt-2 m-0">Caricamento sezioni menu...</p>
			</div>
			}

			<!-- Save Menu Button -->
			@if (menuWsConnection?.connected()) {
			<div class="text-center p-mt-4 save-menu-button">
				<button
					pButton
					type="button"
					label="Salva Menu Attuale"
					icon="pi pi-save"
					class="p-button-success p-button-lg"
					(click)="openSaveMenuDialog()"
					title="Salva il menu attuale per riutilizzarlo in seguito."
				></button>
			</div>
			}
		</div>

		<!-- Pasta Types Section -->
		<div class="card p-mb-4">
			<h3>Tipi di Pasta</h3>
			<button
				pButton
				type="button"
				label="Crea Nuovo Tipo di Pasta"
				icon="pi pi-plus"
				(click)="openNewPastaTypeDialog()"
				class="p-mb-3"
				title="Crea un nuovo tipo di pasta"
			></button>
			<div class="picklist-container">
				<p-pickList
					[source]="pastaTypesSource()"
					[target]="pastaTypesTarget()"
					sourceHeader="Tipi di Pasta Disponibili"
					targetHeader="Selezionati per il Menu"
					[dragdrop]="true"
					[responsive]="true"
					[sourceStyle]="{ height: '250px' }"
					[targetStyle]="{ height: '250px' }"
					filterBy="name"
					sourceFilterPlaceholder="Cerca per nome"
					targetFilterPlaceholder="Cerca per nome"
					(onMoveToTarget)="onPastaTypeMoveToTarget($event)"
					(onMoveToSource)="onPastaTypeMoveToSource($event)"
				>
					<ng-template let-type pTemplate="item">
						<div class="flex flex-wrap p-1 align-items-center gap-2 w-full">
							@if (type.imageUrl) {
							<img
								class="w-3rem shadow-2 shrink-0 border-round"
								[src]="type.imageUrl"
								[alt]="type.name + ' pasta type'"
								title="Pasta type image"
							/>
							} @if (!type.imageUrl) {
							<i
								class="pi pi-image placeholder-icon"
								title="Nessuna immagine disponibile"
							></i>
							}
							<div class="flex-1 flex flex-col">
								<span class="font-bold text-sm">{{ type.name }}</span>
							</div>
							<div class="flex gap-1 image-management-buttons">
								<button
									pButton
									type="button"
									icon="pi pi-images"
									class="p-button-sm p-button-text"
									(click)="openImageManager('pastaType', type)"
									title="Gestisci immagini"
									[attr.aria-label]="'Gestisci immagini per ' + type.name"
								></button>
							</div>
						</div>
					</ng-template>
				</p-pickList>
			</div>
		</div>

		<!-- Pasta Sauces Section -->
		<div class="card p-mb-4">
			<h3>Sughi per Pasta</h3>
			<button
				pButton
				type="button"
				label="Crea Nuovo Sugo per Pasta"
				icon="pi pi-plus"
				(click)="openNewPastaSauceDialog()"
				class="p-mb-3"
				title="Crea un nuovo sugo per pasta"
			></button>
			<div class="picklist-container">
				<p-pickList
					[source]="pastaSaucesSource()"
					[target]="pastaSaucesTarget()"
					sourceHeader="Sughi per Pasta Disponibili"
					targetHeader="Selezionati per il Menu"
					[dragdrop]="true"
					[responsive]="true"
					[sourceStyle]="{ height: '250px' }"
					[targetStyle]="{ height: '250px' }"
					filterBy="name"
					sourceFilterPlaceholder="Cerca per nome"
					targetFilterPlaceholder="Cerca per nome"
					(onMoveToTarget)="onPastaSauceMoveToTarget($event)"
					(onMoveToSource)="onPastaSauceMoveToSource($event)"
				>
					<ng-template let-sauce pTemplate="item">
						<div class="flex flex-wrap p-1 align-items-center gap-2 w-full">
							@if (sauce.imageUrl) {
							<img
								class="w-3rem shadow-2 shrink-0 border-round"
								[src]="sauce.imageUrl"
								[alt]="sauce.name + ' pasta sauce'"
								title="Pasta sauce image"
							/>
							} @if (!sauce.imageUrl) {
							<i
								class="pi pi-image placeholder-icon"
								title="Nessuna immagine disponibile"
							></i>
							}
							<div class="flex-1 flex flex-col">
								<span class="font-bold text-sm">{{ sauce.name }}</span>
							</div>
							<div class="flex gap-1 image-management-buttons">
								<button
									pButton
									type="button"
									icon="pi pi-images"
									class="p-button-sm p-button-text"
									(click)="openImageManager('pastaSauce', sauce)"
									title="Gestisci immagini per {{ sauce.name }}"
									[attr.aria-label]="'Gestisci immagini per ' + sauce.name"
								></button>
							</div>
						</div>
					</ng-template>
				</p-pickList>
			</div>
		</div>
	</div>
	}

	<!-- Dialog for New Pasta Type -->
	<p-dialog
		header="Crea Nuovo Tipo di Pasta"
		[(visible)]="showNewPastaTypeDialog"
		[modal]="true"
		[style]="{ width: '50vw' }"
		[draggable]="false"
		[resizable]="false"
		styleClass="create-pasta-type-dialog"
	>
		<div class="p-fluid">
			<div class="p-field p-mb-3">
				<label for="newPastaTypeName">Nome</label>
				<input
					id="newPastaTypeName"
					type="text"
					pInputText
					[ngModel]="newPastaTypeName()"
					(ngModelChange)="newPastaTypeName.set($event)"
				/>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaTypeDescription">Descrizione (Opzionale)</label>
				<textarea
					id="newPastaTypeDescription"
					pInputTextarea
					rows="3"
					[ngModel]="newPastaTypeDescription()"
					(ngModelChange)="newPastaTypeDescription.set($event)"
					placeholder="Descrivi questo tipo di pasta..."
				></textarea>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaTypeBasePrice">Prezzo Base (€)</label>
				<p-inputNumber
					id="newPastaTypeBasePrice"
					[ngModel]="newPastaTypeBasePrice()"
					(ngModelChange)="newPastaTypeBasePrice.set($event)"
					mode="currency"
					currency="EUR"
					locale="it-IT"
					[min]="0"
					[max]="100"
					[step]="0.50"
				></p-inputNumber>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaTypePriceNote">Nota Prezzi (Opzionale)</label>
				<input
					id="newPastaTypePriceNote"
					type="text"
					pInputText
					[ngModel]="newPastaTypePriceNote()"
					(ngModelChange)="newPastaTypePriceNote.set($event)"
					placeholder="es. per porzione extra, con supplemento, ecc."
				/>
			</div>
			<div class="p-field">
				<label for="newPastaTypeImage">Carica Immagine (Opzionale)</label>
				<p-fileUpload
					mode="basic"
					name="image"
					accept="image/*"
					[maxFileSize]="10000000"
					[auto]="false"
					chooseLabel="Scegli Immagine"
					(onSelect)="onNewPastaTypeImageSelect($event)"
					[disabled]="uploadingNewPastaTypeImage()"
				></p-fileUpload>
				@if (uploadingNewPastaTypeImage()) {
				<p class="p-mt-2">
					<i class="pi pi-spin pi-spinner"></i> Caricamento...
				</p>
				}
				@if (newPastaTypeSelectedFile()) {
				<p class="p-mt-2 text-green-600">
					<i class="pi pi-check"></i> Immagine selezionata: {{ newPastaTypeSelectedFile()?.name }}
				</p>
				}
			</div>
		</div>
		<ng-template pTemplate="footer">
			<button
				pButton
				type="button"
				label="Annulla"
				icon="pi pi-times"
				(click)="showNewPastaTypeDialog.set(false)"
				class="p-button-text"
				title="Annulla creazione tipo di pasta"
			></button>
			<button
				pButton
				type="button"
				label="Salva"
				icon="pi pi-check"
				(click)="saveNewPastaType()"
				title="Salva nuovo tipo di pasta"
			></button>
		</ng-template>
	</p-dialog>

	<!-- Dialog for New Pasta Sauce -->
	<p-dialog
		header="Crea Nuovo Sugo per Pasta"
		[(visible)]="showNewPastaSauceDialog"
		[modal]="true"
		[style]="{ width: '50vw' }"
		[draggable]="false"
		[resizable]="false"
		styleClass="create-pasta-sauce-dialog"
	>
		<div class="p-fluid">
			<div class="p-field p-mb-3">
				<label for="newPastaSauceName">Nome</label>
				<input
					id="newPastaSauceName"
					type="text"
					pInputText
					[ngModel]="newPastaSauceName()"
					(ngModelChange)="newPastaSauceName.set($event)"
				/>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaSauceDescription">Descrizione (Opzionale)</label>
				<textarea
					id="newPastaSauceDescription"
					pInputTextarea
					rows="3"
					[ngModel]="newPastaSauceDescription()"
					(ngModelChange)="newPastaSauceDescription.set($event)"
					placeholder="Descrivi questo sugo..."
				></textarea>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaSauceBasePrice">Prezzo Base (€)</label>
				<p-inputNumber
					id="newPastaSauceBasePrice"
					[ngModel]="newPastaSauceBasePrice()"
					(ngModelChange)="newPastaSauceBasePrice.set($event)"
					mode="currency"
					currency="EUR"
					locale="it-IT"
					[min]="0"
					[max]="50"
					[step]="0.50"
				></p-inputNumber>
			</div>
			<div class="p-field p-mb-3">
				<label for="newPastaSaucePriceNote">Nota Prezzi (Opzionale)</label>
				<input
					id="newPastaSaucePriceNote"
					type="text"
					pInputText
					[ngModel]="newPastaSaucePriceNote()"
					(ngModelChange)="newPastaSaucePriceNote.set($event)"
					placeholder="es. con ingredienti extra, porzione doppia, ecc."
				/>
			</div>
			<div class="p-field">
				<label for="newPastaSauceImage">Carica Immagine (Opzionale)</label>
				<p-fileUpload
					mode="basic"
					name="image"
					accept="image/*"
					[maxFileSize]="10000000"
					[auto]="false"
					chooseLabel="Scegli Immagine"
					(onSelect)="onNewPastaSauceImageSelect($event)"
					[disabled]="uploadingNewPastaSauceImage()"
				></p-fileUpload>
				@if (uploadingNewPastaSauceImage()) {
				<p class="p-mt-2">
					<i class="pi pi-spin pi-spinner"></i> Caricamento...
				</p>
				}
				@if (newPastaSauceSelectedFile()) {
				<p class="p-mt-2 text-green-600">
					<i class="pi pi-check"></i> Immagine selezionata: {{ newPastaSauceSelectedFile()?.name }}
				</p>
				}
			</div>
		</div>
		<ng-template pTemplate="footer">
			<button
				pButton
				type="button"
				label="Annulla"
				icon="pi pi-times"
				(click)="showNewPastaSauceDialog.set(false)"
				class="p-button-text"
				title="Annulla creazione sugo per pasta"
			></button>
			<button
				pButton
				type="button"
				label="Salva"
				icon="pi pi-check"
				(click)="saveNewPastaSauce()"
				title="Salva nuovo sugo per pasta"
			></button>
		</ng-template>
	</p-dialog>

	<!-- Image Management Dialog -->
	<p-dialog
		[header]="'Gestione Immagini - ' + (selectedItemForImages()?.name || '')"
		[(visible)]="showImageManagerDialog"
		[modal]="true"
		[style]="{ width: '70vw' }"
		[draggable]="false"
		[resizable]="false"
		styleClass="image-management-dialog"
	>
		@if (selectedItemForImages(); as item) {
		<div class="p-fluid">
			<!-- Upload Section -->
			<div class="p-field p-mb-4">
				<h4>Carica Nuova Immagine</h4>
				<p-fileUpload
					mode="basic"
					name="image"
					accept="image/*"
					[maxFileSize]="10000000"
					[auto]="false"
					chooseLabel="Scegli Immagine"
					(onSelect)="onImageUpload($event)"
					[disabled]="uploadingImage()"
				>
				</p-fileUpload>
				@if (uploadingImage()) {
				<p class="p-mt-2">
					<i class="pi pi-spin pi-spinner"></i> Caricamento...
				</p>
				}
			</div>

			<!-- Current Image Section -->
			<div class="p-field p-mb-4">
				<h4>Immagine Attuale</h4>
				@if (item.currentImage) {
				<div class="flex align-items-center gap-3">
					<img
						[src]="item.currentImage"
						[alt]="item.name + ' immagine attuale'"
						title="Immagine attuale"
						class="pasta-image"
					/>
					<span>{{ item.currentImage }}</span>
				</div>
				} @else {
				<p>Nessuna immagine attuale impostata</p>
				}
			</div>

			<!-- Available Images Section -->
			<div class="p-field">
				<h4>Immagini Disponibili ({{ item.availableImages.length }})</h4>
				@if (item.availableImages.length > 0) {
				<div class="grid">
					@for (imageUrl of item.availableImages; track imageUrl) {
					<div class="col-6 md:col-4 lg:col-3">
						<div class="p-card p-2">
							<img
								[src]="imageUrl"
								[alt]="item.name + ' immagine disponibile'"
								title="Immagine disponibile"
								class="w-full pasta-image p-mb-2"
							/>
							<div class="flex flex-column gap-2">
								@if (imageUrl !== item.currentImage) {
								<button
									pButton
									type="button"
									label="Imposta come Attuale"
									icon="pi pi-check"
									class="p-button-sm p-button-success"
									(click)="switchToImage(imageUrl)"
									title="Imposta come immagine attuale"
								></button>
								} @else {
								<span class="text-green-600 font-bold text-sm">
									<i class="pi pi-check-circle"></i> Immagine Attuale
								</span>
								}
								<button
									pButton
									type="button"
									label="Elimina"
									icon="pi pi-trash"
									class="p-button-sm p-button-danger"
									(click)="deleteImage(imageUrl)"
									title="Elimina questa immagine"
								></button>
							</div>
						</div>
					</div>
					}
				</div>
				} @else {
				<p>Nessuna immagine disponibile. Carica un'immagine per iniziare.</p>
				}
			</div>
		</div>
		}
		<ng-template pTemplate="footer">
			<button
				pButton
				type="button"
				label="Chiudi"
				icon="pi pi-times"
				(click)="showImageManagerDialog.set(false)"
				title="Chiudi gestione immagini"
			></button>
		</ng-template>
	</p-dialog>

	<!-- Confirmation Dialog -->
	<p-confirmDialog styleClass="confirmation-dialog"></p-confirmDialog>

	<!-- Saved Menus Section - Always visible at bottom -->
	<div class="saved-menus-section">
		@if (menuWsConnection) {
		<app-saved-menus [menuConnection]="menuWsConnection"></app-saved-menus>
		}
	</div>
</div>
